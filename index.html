<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FoodFinder â€” Smart Image Search</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0e0e0e;
      --card: #1a1a1a;
      --border: #2a2a2a;
      --text: #f5f5f5;
      --muted: #9ca3af;
      --accent: #00aaff;
      --accent2: #00ffcc;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: linear-gradient(90deg, #121212, #1a1a1a);
      padding: 22px 32px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 46px; height: 46px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700;
      color: #000;
    }

    .title { font-size: 20px; font-weight: 700; }
    .subtitle { font-size: 12px; color: var(--muted); }

    main {
      padding: 28px;
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    h3 { margin-top: 0; color: var(--accent2); }

    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 28px;
      text-align: center;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .dropzone.drag {
      border-color: var(--accent);
      background: rgba(0, 170, 255, 0.1);
      color: var(--accent2);
    }

    .preview {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    button {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      color: #000;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: var(--accent2);
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    button.ghost:hover {
      background: rgba(0,170,255,0.1);
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    input[type="password"] {
      background: #111;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      width: 100%;
    }

    #status {
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    #labels .result {
      background: #111;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      margin-top: 6px;
      font-size: 14px;
    }

    #map {
      height: 540px;
      border-radius: 12px;
      overflow: hidden;
    }

    .places {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }

    .place-card {
      background: #111;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }

    .place-name {
      font-weight: 600;
      color: var(--accent2);
    }

    .place-meta {
      font-size: 13px;
      color: var(--muted);
    }

    footer {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 30px 0 60px;
    }

    @media (max-width: 940px) {
      main { grid-template-columns: 1fr; }
      #map { height: 400px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">FF</div>
      <div>
        <div class="title">FoodFinder</div>
        <div class="subtitle">AI-powered food recognition and restaurant discovery</div>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>Upload an image</h3>
      <div id="dropzone" class="dropzone">
        <strong>Drag & drop</strong> a food photo or click to browse<br>
        <small>Try dishes like pizza, sushi, or burgers</small>
        <input id="fileInput" type="file" accept="image/*" style="display:none">
      </div>

      <img id="preview" class="preview" alt="preview" />
      <div class="controls">
        <button id="analyzeBtn" disabled>Analyze Image</button>
        <button id="locateBtn" class="ghost">Use My Location</button>
      </div>

      <label style="display:block;margin-top:16px;font-size:14px;">ðŸ”‘ OpenAI API Key:</label>
      <input id="apiKey" type="password" placeholder="Enter your OpenAI API key here" />

      <div id="status">No image selected</div>
      <div id="labels"></div>
    </section>

    <section class="card">
      <h3>Nearby restaurants</h3>
      <div id="map"></div>
      <div id="places" class="places"></div>
    </section>
  </main>

  <footer>Â© 2025 FoodFinder Demo â€” Powered by OpenAI & OpenStreetMap</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const drop = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const status = document.getElementById('status');
    const labelsDiv = document.getElementById('labels');
    const apiKeyInput = document.getElementById('apiKey');
    const locateBtn = document.getElementById('locateBtn');
    const placesDiv = document.getElementById('places');

    const map = L.map('map').setView([40.4168, -3.7038], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    let currentFile = null;
    let userCoords = null;

    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
    drop.addEventListener('drop', e => {
      e.preventDefault();
      drop.classList.remove('drag');
      handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

    function handleFile(file) {
      if (!file) return;
      currentFile = file;
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = 'block';
      status.textContent = `Selected: ${file.name}`;
      analyzeBtn.disabled = false;
    }

    locateBtn.addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          userCoords = [pos.coords.latitude, pos.coords.longitude];
          map.setView(userCoords, 14);
          L.marker(userCoords).addTo(map).bindPopup('You are here').openPopup();
          status.textContent = 'Location acquired.';
        }, () => alert('Location access denied.'));
      } else alert('Geolocation not supported.');
    });

    analyzeBtn.addEventListener('click', async () => {
      if (!currentFile) return alert('Please upload a food image first.');
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) return alert('Please enter your OpenAI API key.');

      status.textContent = 'Analyzing image with OpenAI...';
      const base64Image = await toBase64(currentFile);

      const response = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4.1-mini',
          input: [{
            role: 'user',
            content: [
              { type: 'input_text', text: 'Identify the type of food in this image. Give short labels like "pizza", "sushi", "pasta".' },
              { type: 'input_image', image_url: base64Image }
            ]
          }]
        })
      });

      const result = await response.json();
      const textOutput = result.output_text || 'No response';
      const labels = textOutput.split(/[\\n,]/).map(x => x.trim()).filter(Boolean);
      renderLabels(labels);
      status.textContent = 'Detected: ' + labels.join(', ');
      if (userCoords) searchNearby(labels[0]);
    });

    function renderLabels(labels) {
      labelsDiv.innerHTML = '';
      labels.forEach(l => {
        const el = document.createElement('div');
        el.className = 'result';
        el.textContent = l;
        labelsDiv.appendChild(el);
      });
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });
    }

    async function searchNearby(foodType) {
      if (!userCoords) return alert('Please allow location and try again.');
      status.textContent = `Searching nearby restaurants for ${foodType}...`;
      markersLayer.clearLayers();
      placesDiv.innerHTML = '';

      const [lat, lon] = userCoords;
      const query = `[out:json];node["amenity"="restaurant"](around:4000,${lat},${lon});out;`;
      const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
      const data = await res.json();

      let filtered = data.elements.filter(e => {
        const name = e.tags.name || '';
        return name.toLowerCase().includes(foodType.toLowerCase());
      }).slice(0, 20);

      if (!filtered.length) {
        status.textContent = `No nearby ${foodType} restaurants found. Showing all nearby restaurants.`;
        filtered = data.elements.slice(0, 20);
      }

      filtered.forEach(r => {
        L.marker([r.lat, r.lon]).addTo(markersLayer).bindPopup(r.tags.name || 'Unnamed');
        const card = document.createElement('div');
        card.className = 'place-card';
        card.innerHTML = `<div class='place-name'>${r.tags.name || 'Unnamed'}</div>
                          <div class='place-meta'>${foodType} â€¢ ${(r.tags.addr_city || 'Nearby')}</div>`;
        placesDiv.appendChild(card);
      });

      status.textContent = `Found ${filtered.length} nearby restaurants related to ${foodType}.`;
    }
  </script>
</body>
</html>
